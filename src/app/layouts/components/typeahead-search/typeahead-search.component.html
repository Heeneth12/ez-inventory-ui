<div class="relative w-full group" #searchContainer>
  <!-- Input Wrapper -->
  <div class="relative flex items-center transition-all duration-300"
    [class.shadow-lg]="isFocused() || isAdvancedOpen()" [class.ring-2]="isFocused()"
    [class.ring-indigo-100]="isFocused()" class="bg-white border border-slate-200 rounded-xl overflow-hidden">

    <!-- Search Icon -->
    <div class="absolute left-3.5 text-slate-400 pointer-events-none">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
    </div>

    <!-- Main Input -->
    <input #searchInput type="text" [ngModel]="searchQuery()" (ngModelChange)="onSearchInput($event)"
      (keydown)="handleKeydown($event)" (focus)="isFocused.set(true)" [placeholder]="placeholder"
      class="w-full pl-11 pr-24 py-3 text-sm text-slate-700 placeholder:text-slate-400 focus:outline-none bg-transparent" />

    <!-- Right Actions -->
    <div class="absolute right-2 flex items-center gap-1">
      <!-- Count Badge -->
      <span *ngIf="searchQuery() || isAdvancedOpen()"
        class="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-full mr-1 transition-all">
        {{ filteredCount() }}
      </span>

      <!-- Filter Toggle (Only show if filters are configured) -->
      <button *ngIf="config.filters?.length" (click)="toggleAdvanced()" [class.bg-indigo-600]="isAdvancedOpen()"
        [class.text-white]="isAdvancedOpen()" [class.text-slate-400]="!isAdvancedOpen()"
        [class.hover:bg-slate-100]="!isAdvancedOpen()"
        class="p-1.5 rounded-lg transition-colors duration-200 relative group/btn" title="Advanced Filters">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
        </svg>
      </button>
    </div>
  </div>

  <!-- --- Dynamic Advanced Filters Panel --- -->
  <div *ngIf="isAdvancedOpen() && config.filters?.length"
    class="absolute top-full left-0 right-0 mt-2 p-4 bg-white/90 backdrop-blur-xl rounded-xl shadow-2xl border border-slate-200/60 z-30 animate-in fade-in slide-in-from-top-2 duration-200">

    <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
      <h3 class="text-xs font-bold uppercase tracking-wider text-slate-400">Refine Search</h3>
      <button (click)="resetFilters()"
        class="text-xs text-indigo-500 hover:text-indigo-700 font-semibold transition-colors">Clear All</button>
    </div>

    <div class="grid grid-cols-1 gap-4" [class.sm:grid-cols-2]="config.filters!.length > 1">

      <!-- Dynamic Filter Loop -->
      <div *ngFor="let filter of config.filters" class="space-y-1.5">
        <label class="text-xs font-medium text-slate-600">{{ filter.label }}</label>

        <!-- Type: Select -->
        <div *ngIf="filter.type === 'select'" class="relative">
          <select [ngModel]="getFilterValue(filter.key)" (ngModelChange)="setFilterValue(filter.key, $event)"
            class="w-full appearance-none pl-3 pr-8 py-2 text-sm bg-slate-50 border border-slate-200 rounded-lg focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-colors cursor-pointer text-slate-700">
            <option [ngValue]="null">All {{ filter.label }}s</option>
            <option *ngFor="let opt of filter.options" [value]="opt">{{ opt }}</option>
          </select>
          <div class="absolute right-2 top-2.5 pointer-events-none text-slate-400">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </div>
        </div>

        <!-- Type: Pills -->
        <div *ngIf="filter.type === 'pills'" class="flex flex-wrap gap-2">
          <button *ngFor="let opt of filter.options" (click)="togglePillFilter(filter.key, opt)"
            [class.bg-indigo-600]="getFilterValue(filter.key) === opt"
            [class.text-white]="getFilterValue(filter.key) === opt"
            [class.border-indigo-600]="getFilterValue(filter.key) === opt"
            [class.bg-white]="getFilterValue(filter.key) !== opt"
            [class.text-slate-600]="getFilterValue(filter.key) !== opt"
            [class.border-slate-200]="getFilterValue(filter.key) !== opt"
            [class.hover:border-indigo-300]="getFilterValue(filter.key) !== opt"
            class="px-3 py-1.5 rounded-lg text-xs font-medium border transition-all duration-200">
            {{ opt }}
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- --- Dropdown Results --- -->
  <div *ngIf="isFocused() && (searchQuery() || isAdvancedOpen())"
    class="absolute top-full left-0 right-0 mt-2 bg-white/95 backdrop-blur-xl rounded-xl shadow-2xl border border-slate-200/60 overflow-hidden z-40 flex flex-col animate-in fade-in slide-in-from-top-1 duration-200 max-h-[500px]">

    <!-- List Container -->
    <div class="overflow-y-auto custom-scrollbar p-2 space-y-1">

      <!-- Empty State -->
      <div *ngIf="filteredItems().length === 0" class="py-12 px-6 text-center">
        <div
          class="bg-slate-50 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-3 border border-slate-100">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <p class="font-medium text-slate-800">No matching items</p>
        <p class="text-xs text-slate-500 mt-1">Try changing your filters or search term</p>
      </div>

      <!-- Result Items (Generic Rendering) -->
      <button *ngFor="let item of filteredItems(); let i = index" (click)="selectItem(item)"
        [class.border-indigo-100]="i === activeIndex()"
        class="w-full text-left p-3 rounded-lg hover:bg-slate-50 transition-all duration-200 flex items-center gap-4 group border border-transparent focus:outline-none relative">
        <!-- Avatar (Optional) -->
        <div *ngIf="config.avatarColorKey"
          class="h-10 w-10 rounded-full flex items-center justify-center text-white text-sm font-bold shadow-sm ring-2 ring-white shrink-0"
          [style.background-color]="getItemValue(item, config.avatarColorKey)">
          {{ getInitials(getItemValue(item, config.mainTextKey)) }}
        </div>

        <!-- Content -->
        <div class="flex-1 min-w-0">
          <div class="flex justify-between items-center mb-0.5">
            <h4 class="font-semibold text-sm text-slate-800 truncate pr-2">
              <span [innerHTML]="highlightText(getItemValue(item, config.mainTextKey))"></span>
            </h4>

            <!-- Status Pill (Optional) -->
            <span *ngIf="config.statusKey" [class]="getStatusBadgeClass(getItemValue(item, config.statusKey))"
              class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider shrink-0">
              {{ getItemValue(item, config.statusKey) }}
            </span>
          </div>

          <div class="flex items-center gap-2 text-xs text-slate-500">
            <span class="truncate" *ngIf="config.subTextKey">{{ getItemValue(item, config.subTextKey) }}</span>

            <span *ngIf="config.subTextKey && config.tagKey" class="w-1 h-1 bg-slate-300 rounded-full shrink-0"></span>

            <!-- Tag (e.g. Role/Dept) -->
            <span *ngIf="config.tagKey" class="text-indigo-600/80 font-medium">
              {{ getItemValue(item, config.tagKey) }}
            </span>
          </div>
        </div>

        <!-- Enter hint (only on active) -->
        <div *ngIf="i === activeIndex()" class="absolute right-3 top-1/2 -translate-y-1/2 hidden sm:block">
          <svg class="w-4 h-4 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
          </svg>
        </div>
      </button>
    </div>

    <!-- Footer -->
    <div
      class="bg-slate-50/80 px-4 py-2 border-t border-slate-100 text-[10px] text-slate-400 flex justify-between items-center">
      <div class="flex gap-2">
        <span class="flex items-center gap-1"><kbd class="bg-white border border-slate-200 rounded px-1">↑</kbd><kbd
            class="bg-white border border-slate-200 rounded px-1">↓</kbd> Navigate</span>
        <span class="flex items-center gap-1"><kbd class="bg-white border border-slate-200 rounded px-1">↵</kbd>
          Select</span>
      </div>
      <span class="flex items-center gap-1"><kbd class="bg-white border border-slate-200 rounded px-1">Esc</kbd>
        Close</span>
    </div>
  </div>
</div>